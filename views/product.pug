//- views/product.pug
doctype html
html
  head
    title= title
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css")
    style.
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      h1 {
        color: #333;
      }
      .nav {
        margin-bottom: 20px;
      }
      .nav a {
        margin-right: 15px;
        text-decoration: none;
        color: #007BFF;
      }
      .nav a:hover {
        text-decoration: underline;
      }
      .product-details {
        border: 1px solid #ddd;
        padding: 20px;
        background-color: #f9f9f9;
        max-width: 600px;
      }
      .product-details p {
        line-height: 1.6;
      }
      .acheter-btn {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #28a745;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
      }
      .acheter-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #message {
        margin-top: 20px;
        font-weight: bold;
      }
  body
    .nav
      a(href='/') Accueil
    h1= produit.nom
    .product-details
      p 
        strong Année de Production : 
        | #{produit.annee}
      p 
        strong Prix : 
        | #{produit.prix} €
      p 
        strong Stock Disponible : 
        | #{produit.stock} articles
      button#acheter-btn.acheter-btn Acheter
      #message
    //- Inclure jQuery
    script(src="/code/jquery.min.js")
    script.
      $(document).ready(function() {
        $('#acheter-btn').click(function() {
          // Confirmation avant l'achat
          if (confirm('Êtes-vous sûr de vouloir acheter ce produit ?')) {
            $.ajax({
              url: '/buy/' + #{produit.id},
              type: 'POST',
              success: function(response) {
                $('#message').text(response.message);
                if (response.success) {
                  // Mettre à jour le stock affiché
                  var nouveauStock = response.nouveauStock;
                  $('.product-details p:nth-child(3)').html('<strong>Stock Disponible : </strong>' + nouveauStock + ' articles');
                  // Si le stock est 0, désactiver le bouton
                  if (nouveauStock === 0) {
                    $('#acheter-btn').prop('disabled', true);
                  }
                }
              },
              error: function(xhr, status, error) {
                $('#message').text('Erreur lors de l\'achat.');
              }
            });
          }
        });
      });